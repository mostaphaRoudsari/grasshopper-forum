{"body": "\nDear butterfly team, thanks for updating the butterfly components.\n\n\n\nNow the demo case for outdoor airflow is working, but only when **step 1.2 update fvScheme** is bypassed.\n\n\n\nFirst, allow me to briefly show the steps of the successful run when step 1.2 is bypassed (note that the and OpenFOAM session is open in the background while running the Butterfly demo file):\n\n\n\n1. create wind tunnel, and use different parameters of **(4,4)** for **_globalRefLevel_** as suggested by Theodoro in this **[post](http://www.grasshopper3d.com/group/ladybug/forum/topics/butterfly-doesn-t-work-with-opefoam-v1606?commentId=2985220%3AComment%3A1579523&amp;groupId=2985220%3AGroup%3A658987)**\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtp4tf12bZFqn0r3fP4I8wMD4U7yeRBPbYyN**WOSmnhpt0xIWmLh0VQrM4FWh7vM44K6d7dznaA6RdM2wWlccYn/Image8.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtp4tf12bZFqn0r3fP4I8wMD4U7yeRBPbYyN**WOSmnhpt0xIWmLh0VQrM4FWh7vM44K6d7dznaA6RdM2wWlccYn/Image8.png)\n\n\n\n2. run **blockMesh**:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtrCMY9Bzyu9CU-NEBk5RLmVWwVhUWMT2DJrdTT3aUPD68*rbWGOZJPBX-Q-*wo3gm8BYFFsNA9LolcFMZuyLQfG/Image9.png\" width=\"717\"/>](http://api.ning.com:80/files/lQF20yFeYtrCMY9Bzyu9CU-NEBk5RLmVWwVhUWMT2DJrdTT3aUPD68*rbWGOZJPBX-Q-*wo3gm8BYFFsNA9LolcFMZuyLQfG/Image9.png)\n\n\n\n\n\n3. run **snappyHexMesh**:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtpZTo-dzQZ2fa*AVl6Etkvkbl9vtPnZBfcJHltwgzSXNaJmf45aluEIyWIMcqPb-NZsZ2P8adjldjlyfsg1ik6e/Image10.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtpZTo-dzQZ2fa*AVl6Etkvkbl9vtPnZBfcJHltwgzSXNaJmf45aluEIyWIMcqPb-NZsZ2P8adjldjlyfsg1ik6e/Image10.png)\n\n\n\n\n\n4. run **checkMesh**:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtojW8JSQ2qZambcPqB-nVEUUMRDlALdkR1PPY9CAZucMjKTNRKhqHGBv7FQ9I7f45ZM02ah7a5SLBW*tl*ce8f4/Image12.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtojW8JSQ2qZambcPqB-nVEUUMRDlALdkR1PPY9CAZucMjKTNRKhqHGBv7FQ9I7f45ZM02ah7a5SLBW*tl*ce8f4/Image12.png)\n\n\n\n\n\n5. connect the case from **checkMesh** to **simpleFOAM** and run the simulation:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtpCavlBAf7*1kYh8BwWlUEl-5C4vTR-AqTtmh7qQKnKIancV1bboFvIjBFb8byKahdvvuFBjajJcB07PIeikYbQ/Image13.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtpCavlBAf7*1kYh8BwWlUEl-5C4vTR-AqTtmh7qQKnKIancV1bboFvIjBFb8byKahdvvuFBjajJcB07PIeikYbQ/Image13.png)\n\n\n\n\n\n6. the simulation converged at 1865 iteration, but the results visualization part has some problem:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtp0sbZAyl2VCQnumE9YkdTlryDF-VgWFOY4vPyjPpuPkVHZ5t2Vg-ohdS271lbBNbDaYM32FS*-6BYKRUfiZplB/Image4.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtp0sbZAyl2VCQnumE9YkdTlryDF-VgWFOY4vPyjPpuPkVHZ5t2Vg-ohdS271lbBNbDaYM32FS*-6BYKRUfiZplB/Image4.png)\n\n\n\n\n\n7. so I revised this part according to suggestions from [Hagit:](http://www.grasshopper3d.com/group/ladybug/forum/topics/butterfly-block-mesh-error?commentId=2985220%3AComment%3A1587110&amp;groupId=2985220%3AGroup%3A658987)\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtp07sHPEIcSunQLgn-mythZkPvQgqgPbo4dNht7TRVPzX8*cO0M40VWZMcQpNBJjzbo0PdnkLascEoXt7nOy7zx/Image14.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtp07sHPEIcSunQLgn-mythZkPvQgqgPbo4dNht7TRVPzX8*cO0M40VWZMcQpNBJjzbo0PdnkLascEoXt7nOy7zx/Image14.png)\n\n\n\n\n\n8. and the results can be visualized for P and U values:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtrQpytW9HGD4d04dPc2d5zngsx5zAvm03vEL2exfR4x4cRBSgY-Hmht67-j1JCVARI0WoDZbCy6caynHu*iQqaW/Image5.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtrQpytW9HGD4d04dPc2d5zngsx5zAvm03vEL2exfR4x4cRBSgY-Hmht67-j1JCVARI0WoDZbCy6caynHu*iQqaW/Image5.png)[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtrAtIHXk3cyLYfl83kUEV7yZDo*kvQtRm4HcF9kMVNRT0k20Y06uppGvFXRHj7k-kNbDtw2vCpWhWFdSOYi2ptJ/Image6.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtrAtIHXk3cyLYfl83kUEV7yZDo*kvQtRm4HcF9kMVNRT0k20Y06uppGvFXRHj7k-kNbDtw2vCpWhWFdSOYi2ptJ/Image6.png)\n\n\n\nThe GH file used for the successful run shown above is attached here.\n\n\n\n\n\nNow, the following is the error I got when the case from the update fvScheme component is used for simpleFOAM simulation:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtr6O-cjWZf1md5*1n0wGHypMtgI5W9Dan2lh0089tQWW4dyDPWZAJruVKc3eyTYHC3VPgZf5Wd*cXxw1mGOvyk2/Image7.png?width=750\" width=\"750\"/>](http://api.ning.com:80/files/lQF20yFeYtr6O-cjWZf1md5*1n0wGHypMtgI5W9Dan2lh0089tQWW4dyDPWZAJruVKc3eyTYHC3VPgZf5Wd*cXxw1mGOvyk2/Image7.png)\n\nthe warning message on the simpleFOAM component is:\n\n1. Solution exception:<br/> \u00a0--&gt; OpenFOAM command Failed!#0\u00a0 Foam::error::printStack(Foam::Ostream&amp;) in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libOpenFOAM.so\"<br/> \u00a0#1\u00a0 Foam::sigFpe::sigHandler(int) in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libOpenFOAM.so\"<br/> \u00a0#2\u00a0 ? in \"/lib64/libc.so.6\"<br/> \u00a0#3\u00a0 double Foam::sumProd&lt;double&gt;(Foam::UList&lt;double&gt; const&amp;, Foam::UList&lt;double&gt; const&amp;) in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libOpenFOAM.so\"<br/> \u00a0#4\u00a0 Foam::PCG::solve(Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt; const&amp;, unsigned char) const in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libOpenFOAM.so\"<br/> \u00a0#5\u00a0 Foam::GAMGSolver::solveCoarsestLevel(Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt; const&amp;) const in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libOpenFOAM.so\"<br/> \u00a0#6\u00a0 Foam::GAMGSolver::Vcycle(Foam::PtrList&lt;Foam::lduMatrix::smoother&gt; const&amp;, Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt; const&amp;, Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt;&amp;, Foam::PtrList&lt;Foam::Field&lt;double&gt; &gt;&amp;, Foam::PtrList&lt;Foam::Field&lt;double&gt; &gt;&amp;, unsigned char) const in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libOpenFOAM.so\"<br/> \u00a0#7\u00a0 Foam::GAMGSolver::solve(Foam::Field&lt;double&gt;&amp;, Foam::Field&lt;double&gt; const&amp;, unsigned char) const in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libOpenFOAM.so\"<br/> \u00a0#8\u00a0 Foam::fvMatrix&lt;double&gt;::solveSegregated(Foam::dictionary const&amp;) in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/lib/libfiniteVolume.so\"<br/> \u00a0#9\u00a0 Foam::fvMatrix&lt;double&gt;::solve(Foam::dictionary const&amp;) in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/bin/simpleFoam\"<br/> \u00a0#10\u00a0 Foam::fvMatrix&lt;double&gt;::solve() in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/bin/simpleFoam\"<br/> \u00a0#11\u00a0 ? in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/bin/simpleFoam\"<br/> \u00a0#12\u00a0 __libc_start_main in \"/lib64/libc.so.6\"<br/> \u00a0#13\u00a0 ? in \"/opt/OpenFOAM/OpenFOAM-v1606+/platforms/linux64GccDPInt32Opt/bin/simpleFoam\"<br/>\n\n\n\nThe error message from the readMe! output node is attached below as a text file.\n\n\n\nHope you can kindly advise what the important steps or parameters I might have missed here. I assume it might be related to OpenFOAM rather than with the Butterfly workflow...\n\n\n\nThank you very much!\n\n- Ji\n\n\n\n\n", "attachments": [{"link": "http://www.grasshopper3d.com/group/ladybug/forum/attachment/download?id=2985220%3AUploadedFile%3A1589317", "name": "butterfly_simpleFOAM_error.txt"}, {"link": "http://www.grasshopper3d.com/group/ladybug/forum/attachment/download?id=2985220%3AUploadedFile%3A1589318", "name": "outdoor_airflow_ZJ_v004.gh"}], "created_by_name": "Grasshope", "created_at": "August 27, 2016 at 1:14am", "created_by": "Grasshope", "topic": "butterfly test: simulation for case with fvScheme updated is not working", "replies": [{"body": "\nHi Ji,\n\n\n\nThanks for sharing this, glad to see that you have are running whole simulations now! The results look ok, wake regions are where they are supposed to be. Ofc, I can tell the mesh quality is still quite rough.\n\n\n\nI went through your attached log but it seems to be a successful run, perhaps the error log wasn't attached. In any case, I believe we have identified this issue. The goal of the update fvSchemes component was to apply schemes to finalized meshes in an automatic way. While this is useful for new users it is also a dangerous thing to do in CFD studies.\n\n\n\nThe component works by relating mesh quality to the mesh non-orthogonality, which the checkMesh component reports. While non-orthogonality is one of the important criteria of mesh quality it does present difficulties on some kind of meshes, especially like the simple cases that BF has been meshing so far.\n\n\n\nThe example case of simple box buildings in a wind tunnel above for instance will appear as a good quality case for even the lowest of cell-count meshes, simply because it is an orthogonal geometry. That means that checkMesh will probably report low values (imagine an empty blockMesh of 10m blocks has a non-orthogonality of 0) which in turn means that higher order schemes might be paired with actually low quality meshes. This I believe is causing problems.\u00a0\n\n\n\nI posted a possible solution to this here\u00a0[https://github.com/mostaphaRoudsari/Butterfly/issues/57](https://github.com/mostaphaRoudsari/Butterfly/issues/57). The idea is that Buttefly provides additional options to the users, enabling them to choose between first-order (faster, more robust, but lower quality schemes) and second-order (slower, less robust, but more accurate) schemes depending on mesh quality, stage of assessment, etc. In cases like the above mesh quality a first-order scheme might provide a better option. To test this I am attaching an fvSchemes file you can use by replacing yours in the /system folder of the case.\u00a0\n\n\n\nAs a note however, I would like to stress there is so much that a tool like Butterfly can provide in this area. Meshing is a quite complicated and demanding part of the process, involving a lot of trial and error. Sometimes the problem is just the mesh and not the solution options (GIGO stands true in CFD as well). It does however get easier with experience. The safe advice is the simplest one: when changing solution options doesn't help, refine mesh and run again.\n\n\u00a0\n\nKind regards,\n\nTheodore.\n", "attachments": [{"link": "http://www.grasshopper3d.com/group/ladybug/forum/attachment/download?id=2985220%3AUploadedFile%3A1589262", "name": "fvSchemes"}], "created_by_name": "Theodoros Galanos", "created_at": "August 27, 2016 at 1:59am", "created_by": "TheodorosGalanos", "replies": [{"body": "\nDear Theodoros,\n\n\n\nThank you very much for the prompt reply and the detailed advice!\n\n\n\nThe following image shows the fvScheme file **before** and **after** running the **update fvScheme** component, and the **fvScheme file you shared** in the above post. The differences are highlighted. Are they correct?\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtrM3kg*totMwI-n24YWHp5vkKAkGCvNLVFeDk5hYvreXijXFZz1ghU7nw3FRvOfvIKtfI2787LOCjK4heSJCP3U/Image5.png?width=721\" width=\"721\"/>](http://api.ning.com:80/files/lQF20yFeYtrM3kg*totMwI-n24YWHp5vkKAkGCvNLVFeDk5hYvreXijXFZz1ghU7nw3FRvOfvIKtfI2787LOCjK4heSJCP3U/Image5.png)\n\n\n\nI replaced the fvScheme file with the one you shared, and ran the simpleFOAM component. Now, there is no warning, but the simulation didn't converge after the 2000 iterations:\n\n[<img class=\"align-full\" src=\"http://api.ning.com:80/files/lQF20yFeYtoT4X-MVYGnSKqRRsgtGnGCFNg3mpSpLg2qAVgW0Z-SrT-b1gg8vJWbM4UeMmegGFTssEBaCjPYo7bykrkEqvRO/Image3.png?width=721\" width=\"721\"/>](http://api.ning.com:80/files/lQF20yFeYtoT4X-MVYGnSKqRRsgtGnGCFNg3mpSpLg2qAVgW0Z-SrT-b1gg8vJWbM4UeMmegGFTssEBaCjPYo7bykrkEqvRO/Image3.png)\n\n\n\nthen I changed the number connected to the **_endTime_** from 2000 to 4000, and the simulation continued for another 2000 iterations without any sign of converge ... and then GH freezes completely ... and Rhino+GH has to be shut down ...\n\n\n\nWhile waiting for the team to consider the \"first/second order\" function to be added to the update fvScheme component as you suggested on GitHub, may I ask how to improve the mesh quality before the update fvScheme step?\n\n\n\nThank you very much!\n\n- Ji\n", "attachments": [], "created_by_name": "Grasshope", "created_at": "August 27, 2016 at 7:57am", "created_by": "Grasshope", "replies": []}, {"body": "\nHi Ji,\n\n\n\nGlad to hear the simulation kept on working with the updated fvSchemes. I think it looks alright to be honest. Not converging is not really an issue because it does look converged to me at least for the quality of the mesh.\n\n\n\nActually, convergence is much more than simply having low residuals. You can have a wrong solution with very low residuals. Usually, it is a combined process of both run time information on residuals and having an idea or expectation of what the simulation results should be. Another way of assessing convergence is if the residual values have been stable (within a very small limit, e.g. 1E-5) for more than a certain number of iterations (e.g. 1000). We are planning to provide run-time residual plots in Butterfly, hopefully soon. These plots can help keeping an eye on the solution.\n\n\n\nYou could try as a test if you want to switch to a blend of first and second order (by swapping upwind with linearUpwind in the fvSchemes)\n\n.\u00a0\n\nConcerning mesh quality there are a number of ways, some of which are a bit advanced for this post and for BF's current\u00a0capabilities. The best way to start is by refining the background mesh (i.e. the blockMesh). You can do that by assigning more cells to the x, y and z directions in the blockMesh component. However, make sure you increase the max global cells. I would suggest you monitor the output of the blockMesh in order to know the total number of cells there. Your max global cells has to be higher than that for SHM to even work. I'd suggest 2x to start with. Ofc all that requires a bit of trial and error depending on the case at hand.\n\n\n\nHope this helps!\n\n\n\nKind regards,\n\nTheodore.\n", "attachments": [], "created_by_name": "Theodoros Galanos", "created_at": "August 27, 2016 at 10:07am", "created_by": "TheodorosGalanos", "replies": []}, {"body": "\nAdding refinement regions should provide a good level of flexibility in meshing workflow.\n\n[https://github.com/mostaphaRoudsari/Butterfly/issues/59](https://github.com/mostaphaRoudsari/Butterfly/issues/59)\n\nI wonder if we should stop auto updating fv-scheme and let users choose between available options. Similar to radiance parameters. We can just suggest based on the mesh but don't change the default?\n", "attachments": [], "created_by_name": "Mostapha Sadeghipour Roudsari", "created_at": "September 11, 2016 at 9:31am", "created_by": "MostaphaSadeghipour", "replies": []}]}], "id": "1589319"}